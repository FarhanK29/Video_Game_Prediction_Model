# -*- coding: utf-8 -*-
"""SteamdbTestFetch.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/171WTe8jTschiFExJPm9jRqBOggYGps53
"""

import requests
import json
from datetime import datetime

def search_game(game_name):
    """
    Search game on Steam return AppID(most relevant).
    """
    print(f"Searching for '{game_name}'...")

    # Used for Game Optimization
    url = "https://store.steampowered.com/api/storesearch/"
    params = {
        "term": game_name,
        "l": "english",
        "cc": "US"
    }

    try:
        response = requests.get(url, params=params)
        data = response.json()

        if data['total'] > 0:
            # Get the first result
            first_match = data['items'][0]
            print(f"Found: {first_match['name']} (AppID: {first_match['id']})")
            return first_match['id'], first_match['name']
        else:
            print("No game found")
            return None, None

    except Exception as e:
        print(f"Error searching game: {e}")
        return None, None

def get_game_details(app_id):
    """
    Retrieves Publisher Developer and Release Date from SteamDB.
    """
    url = "https://store.steampowered.com/api/appdetails"
    params = {"appids": app_id}

    try:
        response = requests.get(url, params=params)
        data = response.json()

        if data[str(app_id)]['success']:
            game_data = data[str(app_id)]['data']
            # Fetch Developers
            developers = game_data.get('developers', ['Unknown'])
            # Fetch Publishers
            publishers = game_data.get('publishers', ['Unknown'])
            # Fetch Release Date
            release_date_data = game_data.get('release_date', {})
            release_date = release_date_data.get('date', 'Unknown')

            return {
                "developers": ", ".join(developers),
                "publishers": ", ".join(publishers),
                "release_date": release_date
            }
        else:
            return None

    except Exception as e:
        print(f"Error getting details: {e}")
        return None

def get_popularity_stats(app_id):
    """
    Retrieves Review count (proxy for Wishlists).
    """
    # Use the app reviews to give us summarized stats
    url = f"https://store.steampowered.com/appreviews/{app_id}"
    params = {
        "json": 1,
        "language": "all",
        "purchase_type": "all"
    }

    try:
        response = requests.get(url, params=params)
        data = response.json()
        if 'query_summary' in data:
            summary = data['query_summary']
            return {
                "total_reviews": summary.get('total_reviews', 0),
                "review_score_desc": summary.get('review_score_desc', 'N/A'),
                "positive_reviews": summary.get('total_positive', 0),
                "negative_reviews": summary.get('total_negative', 0)
            }
        return None

    except Exception as e:
        print(f"Error getting stats: {e}")
        return None

def main():
    print("--- Steam Game Data Fetcher ---")
    user_input = input("Enter game name: ")

    # 1 Search for game
    app_id, real_name = search_game(user_input)
    if app_id:
        print("\nFetching details...")
        # 2 Get Metadata (Dev, Pub, Date)
        details = get_game_details(app_id)
        # 3 Get Stats (Reviews)
        stats = get_popularity_stats(app_id)
        print("\n" + "="*40)
        print(f" GAME: {real_name}")
        print("="*40)
        if details:
            print(f" Developer:    {details['developers']}")
            print(f" Publisher:    {details['publishers']}")
            print(f" Release Date: {details['release_date']}")
        print("-" * 40)

        if stats:
            # Explaining Wishlists and Review Data
            print(f" Using Review Count > Wishlist")
            print(f" Fetching Data")
            print(f"     (Industry Stat, Wishlists â‰ˆ 10-20x Review Count)")
            print("-" * 40)
            print(f" Total Reviews: {stats['total_reviews']:,}")
            print(f" User Rating:   {stats['review_score_desc']}")
            print(f" Positive:      {stats['positive_reviews']:,}")
            print(f" Negative:      {stats['negative_reviews']:,}")

        print("="*40 + "\n")

if __name__ == "__main__":
    main()